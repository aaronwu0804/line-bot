# Gemini API 配額管理指南

## 概述
本文檔說明如何處理 Gemini API 的配額限制問題以及實現的解決方案。

## 問題
使用免費的 Gemini API 時，可能會遇到以下配額限制相關的問題：
- 每分鐘請求數量限制（QPM, Queries Per Minute）
- 每天請求數量限制（QPD, Queries Per Day）
- 連續請求可能導致 429 Too Many Requests 錯誤

## 解決方案

### 1. 智能型緩存系統
我們實現了一個專用的緩存系統，可以：
- 存儲常見問題的回應，減少重複 API 調用
- 設置緩存有效期，確保信息的時效性
- 自動清理過期緩存，節省存儲空間

### 2. 增強型錯誤處理
針對不同類型的 API 錯誤，實現了專門的處理策略：
- 429 錯誤（配額限制）：使用指數退避策略重試
- 404 錯誤（模型未找到）：嘗試回退到其他可用模型
- 400 錯誤（請求格式錯誤）：簡化提示詞後重試

### 3. 模型選擇優化
實現了智能的模型選擇策略：
- 優先使用免費/輕量型模型減少配額消耗，順序為：
  1. `gemini-1.5-flash` (免費)
  2. `gemini-pro-vision` (每月額度)
  3. `gemini-pro` (每月額度)
  4. `gemini-1.5-pro` (按使用付費)
- 智能檢測可用模型，避免模型不存在錯誤
- 在重試過程中適應性調整參數降低復雜度

### 4. 回應生成優化
- 根據重試次數動態調整生成參數
- 降低令牌消耗以避免超過配額限制
- 簡化提示詞以提高成功率

### 5. 健康檢查與監控
- 增強了健康檢查端點，提供詳細的 API 狀態信息
- 監控緩存系統的使用情況
- 提供詳細的日誌用於問題診斷

## 配置建議

### 環境變量
- `GEMINI_API_KEY`：設置您的 Gemini API 密鑰

### 緩存設置
緩存系統可以在 `src/response_cache.py` 中進一步調整：
- 修改 `cache_ttl` 參數調整緩存有效期（默認為 7 天）
- 自定義緩存目錄位置

## 故障排除

如果仍然遇到 API 配額問題，請嘗試：

1. **檢查日誌**
   查看應用日誌中是否有與 API 調用相關的錯誤信息

2. **更新 API 密鑰**
   確保您的 API 密鑰有效且未過期

3. **調整使用頻率**
   如果可能，降低對 AI 功能的請求頻率

4. **升級 API 配額**
   考慮升級到 Gemini API 的付費層級以獲取更高的配額

## 更新日誌

### v2.1.0 (2025-06-05)
- 實現專用緩存系統以減少重複 API 調用
- 增強型錯誤處理機制
- 指數退避策略用於 API 限制
- 改進模型選擇邏輯
- 添加健康檢查詳細信息

### v2.0.2 (2025-06-03)
- 修復 Gemini API 模型選擇問題
- 增強 API 狀態檢查

### v2.0.1 (2025-06-01)
- 初步實現 Gemini API 整合
- 添加基本的錯誤處理
